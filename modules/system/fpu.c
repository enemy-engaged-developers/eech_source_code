// 
// 	 Enemy Engaged RAH-66 Comanche Versus KA-52 Hokum
// 	 Copyright (C) 2000 Empire Interactive (Europe) Ltd,
// 	 677 High Road, North Finchley, London N12 0DA
// 
// 	 Please see the document LICENSE.TXT for the full licence agreement
// 
// 2. LICENCE
//  2.1 	
//  	Subject to the provisions of this Agreement we now grant to you the 
//  	following rights in respect of the Source Code:
//   2.1.1 
//   	the non-exclusive right to Exploit  the Source Code and Executable 
//   	Code on any medium; and 
//   2.1.2 
//   	the non-exclusive right to create and distribute Derivative Works.
//  2.2 	
//  	Subject to the provisions of this Agreement we now grant you the
// 	following rights in respect of the Object Code:
//   2.2.1 
// 	the non-exclusive right to Exploit the Object Code on the same
// 	terms and conditions set out in clause 3, provided that any
// 	distribution is done so on the terms of this Agreement and is
// 	accompanied by the Source Code and Executable Code (as
// 	applicable).
// 
// 3. GENERAL OBLIGATIONS
//  3.1 
//  	In consideration of the licence granted in clause 2.1 you now agree:
//   3.1.1 
// 	that when you distribute the Source Code or Executable Code or
// 	any Derivative Works to Recipients you will also include the
// 	terms of this Agreement;
//   3.1.2 
// 	that when you make the Source Code, Executable Code or any
// 	Derivative Works ("Materials") available to download, you will
// 	ensure that Recipients must accept the terms of this Agreement
// 	before being allowed to download such Materials;
//   3.1.3 
// 	that by Exploiting the Source Code or Executable Code you may
// 	not impose any further restrictions on a Recipient's subsequent
// 	Exploitation of the Source Code or Executable Code other than
// 	those contained in the terms and conditions of this Agreement;
//   3.1.4 
// 	not (and not to allow any third party) to profit or make any
// 	charge for the Source Code, or Executable Code, any
// 	Exploitation of the Source Code or Executable Code, or for any
// 	Derivative Works;
//   3.1.5 
// 	not to place any restrictions on the operability of the Source 
// 	Code;
//   3.1.6 
// 	to attach prominent notices to any Derivative Works stating
// 	that you have changed the Source Code or Executable Code and to
// 	include the details anddate of such change; and
//   3.1.7 
//   	not to Exploit the Source Code or Executable Code otherwise than
// 	as expressly permitted by  this Agreement.
// 



/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include "system.h"

#include <math.h>

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#define FPU_PRECISION_MASK 0xfcff

#define FPU_PRECISION_SINGLE 0x0000

#define FPU_PRECISION_DOUBLE 0x0200

#define FPU_PRECISION_EXTENDED 0x0300

#define FPU_ROUNDING_MASK 0xf3ff

#define FPU_ROUNDING_NEAREST 0x0000

#define FPU_ROUNDING_UP 0x0800

#define FPU_ROUNDING_DOWN 0x0400

#define FPU_ROUNDING_ZERO 0x0c00

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#if !defined ( WIN32 ) || defined ( __GNUC__ )
// _control87(..) implementation and general wizardry by Colin Bayer <vogon@icculus.org>

#define IC_AFFINE 0x1000
#define IC_PROJECTIVE 0x1000
#define MCW_RC 0xC00
#define MCW_RC 0xC00
#define MCW_PC 0x300
#define MCW_EM 0x3F
#define MCW_IC 0x1000
#define RC_NEAR 0x0
#define RC_DOWN 0x400
#define RC_UP 0x800
#define RC_CHOP 0xC00
#define PC_24 0x0
#define PC_53 0x200
#define PC_64 0x300

#ifndef _EM_ZERODIVIDE

#define _EM_ZERODIVIDE 0x4

unsigned short _control87(unsigned short val, unsigned short mask) {
	unsigned short old_cw, new_cw;
	__asm__ __volatile__ ( "fstcw %0;" : "=m" (old_cw) : /* no inputs */ );
	new_cw = (old_cw & ~mask) | (val & mask);
	__asm__ __volatile__ ( "fclex; fldcw %0;" : /* no outputs */ : "m" (new_cw) );
	return old_cw;
}
#endif

#ifndef EM_INVALID

#define	EM_INVALID	_EM_INVALID
#define	EM_DENORMAL	_EM_DENORMAL
#define	EM_ZERODIVIDE	_EM_ZERODIVIDE
#define	EM_OVERFLOW	_EM_OVERFLOW
#define	EM_UNDERFLOW	_EM_UNDERFLOW
#define	EM_INEXACT	_EM_INEXACT

#endif

#endif

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/* This is the default value loaded into the 80x87 control word.
   If you want higher precision, then change PC_53 to PC_64. The
   reason we have the default set to PC_53 is generate reproducible
   floating-point results regardless of the level of optimization
   chosen for the compiler.
   This value is loaded when the 80x87 is initialized by the startup
   code, and also when _fpreset is called.
*/
#ifdef __WATCOMC__
#pragma aux __8087cw "*";
#endif

/*                          0x1000  | 0x0000  | 0x0200 | 0x007F */
unsigned short __8087cw = ( unsigned short ) ( IC_AFFINE | RC_CHOP | PC_53  | 0x007F );

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void convert_float_to_int ( float value, int *integer )
{

//	set_fpu_rounding_mode_zero ();

	asm_convert_float_to_int ( value, integer );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void convert_double_to_int ( double value, int *integer )
{

//	set_fpu_rounding_mode_zero ();

	asm_convert_double_to_int ( value, integer );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

unsigned short int get_fpu_control_word_value ( void )
{

	unsigned short int
		value;

	#ifdef _MSC_VER

	value = asm_get_controlfp ();

	#else

	value = _control87 ( 0, 0 );

	#endif

	return ( value );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_fpu_control_word_value ( unsigned short int value )
{

	#ifdef _MSC_VER

	asm_set_controlfp ( value, value );

	#else

	_control87 ( 0xffff, value );

	#endif
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_fpu_mode_default ( void )
{
	unsigned int _87cw = 0x0e7f;

	set_fpu_control_word_value ( _87cw );
//	initialise_fpu ();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#ifdef DEBUG

static const char* const status[2] = { "disabled", "enabled" };

#endif

void report_fpu_exceptions ( void )
{

	unsigned int
		fp_cw = 0,
		bits;
	
	fp_cw = _control87 ( 0, 0 );
	
	debug_log ( "Interrupt Exception Masks ( %08x )", fp_cw );
	bits = fp_cw & MCW_EM;

	debug_log ( "Invalid Operation exception %s", status[ (bits & EM_INVALID) == 0 ] );
	debug_log ( "Denormalized exception %s", status[ (bits & EM_DENORMAL) == 0 ] );
	debug_log ( "Divide-By-Zero exception %s", status[ (bits & EM_ZERODIVIDE) == 0 ] );
	debug_log ( "Overflow exception %s", status[ (bits & EM_OVERFLOW) == 0 ] );
	debug_log ( "Underflow exception %s", status[ (bits & EM_UNDERFLOW) == 0 ] );
	debug_log ( "Precision exception %s", status[ (bits & EM_INEXACT) == 0 ] );
	
	debug_log ( "Infinity Control = " );
	bits = fp_cw & MCW_IC;
	if ( bits == IC_AFFINE )		{ debug_log ( "affine" );		}
	if ( bits == IC_PROJECTIVE )	{ debug_log ( "projective" ); }
	
	debug_log ( "Rounding Control = " );
	bits = fp_cw & MCW_RC;
	if( bits == RC_NEAR )			{ debug_log ( "near" );	}
	if( bits == RC_DOWN )			{ debug_log ( "down" );	}
	if( bits == RC_UP )				{ debug_log ( "up" );	}
	if( bits == RC_CHOP )			{ debug_log ( "chop" );	}
	
	debug_log ( "Precision Control = " );
	bits = fp_cw & MCW_PC;
	if( bits == PC_24 )				{ debug_log ( "24 bits" );	}
	if( bits == PC_53 )				{ debug_log ( "53 bits" );	}
	if( bits == PC_64 )				{ debug_log ( "64 bits" );	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_fpu_exceptions ( void )
{

//	_control87 ( ~_EM_ZERODIVIDE, MCW_EM );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_fpu_rounding_mode_nearest ( void )
{

	debug_log ( "FPU: nearest" );

	_control87 ( RC_NEAR, MCW_RC );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_fpu_rounding_mode_up ( void )
{

	debug_log ( "FPU: up" );

	_control87 ( RC_UP, MCW_RC );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_fpu_rounding_mode_down ( void )
{

	debug_log ( "FPU: down" );

	_control87 ( RC_DOWN, MCW_RC );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_fpu_rounding_mode_zero ( void )
{

	#ifdef _MSC_VER
	//set_fpu_control_word_value ( RC_CHOP );
	set_fpu_control_word_value ( 0x0c7f );
	#else
	_control87 ( RC_CHOP, MCW_RC );
	#endif
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_fpu_precision_mode_single ( void )
{

	_control87 ( PC_24, MCW_PC );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_fpu_precision_mode_double ( void )
{

	_control87 ( PC_53, MCW_PC );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void set_fpu_precision_mode_extended ( void )
{

	_control87 ( PC_64, MCW_PC );
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

